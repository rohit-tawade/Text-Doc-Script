name: Build Android APK (Kivy)

on:
  workflow_dispatch:
  push:
    paths:
      - "resume_app/**"
      - ".github/workflows/build-android-apk.yml"

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Smoke test core resume -> PDF generation
        run: |
          python - <<'PY'
          import sys
          from pathlib import Path

          sys.path.insert(0, "resume_app")
          import converter

          sample_resume = """Rohit Tawade
          Phone: +91 9999999999
          Email: rohit@example.com
          Address: Pune
          Nationality: Indian
          Company Name:

          Site Reliability Engineer

          Professional Summary
          SRE focused on Kubernetes, CI/CD, observability, and platform reliability.

          Professional Experience
          Example Corp - Site Reliability Engineer
          Jan 2024 - Dec 2024
          * Operated Kubernetes clusters.
          * Built CI/CD pipelines.

          Technical Skills
          * Containers: Kubernetes, Docker
          * Observability: Prometheus, Grafana

          Certification
          * Example Certification

          Education
          * MCA, University, 2018
          """

          out_dir = Path("ci_smoke")
          out_dir.mkdir(parents=True, exist_ok=True)
          out_pdf = out_dir / "smoke.pdf"
          result = converter.convert_text_to_pdf(sample_resume, out_pdf, source_hint="rohit-tawade-sre.txt")
          pdf_path = Path(result)
          data = pdf_path.read_bytes()

          assert pdf_path.exists(), "Smoke PDF was not created"
          assert data.startswith(b"%PDF-"), "Output is not a PDF"
          assert len(data) > 1000, f"PDF too small ({len(data)} bytes)"
          for token in (b"Rohit Tawade", b"PROFESSIONAL SUMMARY", b"Kubernetes", b"EDUCATION"):
              assert token in data, f"Expected token missing from PDF bytes: {token!r}"
          print(f"Smoke test OK: {pdf_path} ({len(data)} bytes)")
          PY

      - name: Syntax check app code
        run: |
          python -m py_compile resume_app/main.py resume_app/converter.py

      - name: Upload smoke-test PDF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resume-app-smoke-pdf
          path: ci_smoke/smoke.pdf
          if-no-files-found: ignore

      - name: Cache Buildozer and p4a downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer/android/packages
          key: buildozer-${{ runner.os }}-${{ hashFiles('resume_app/buildozer.spec', 'resume_app/main.py', 'resume_app/converter.py') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip openjdk-17-jdk autoconf automake libtool gettext autopoint pkg-config m4 \
            zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo6 \
            cmake libffi-dev libssl-dev libsqlite3-dev libjpeg-dev \
            liblzma-dev libbz2-dev

      - name: Install Buildozer
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install "cython<3.1" buildozer

      - name: Build debug APK
        working-directory: resume_app
        env:
          ANDROIDSDK: /home/runner/.buildozer/android/platform/android-sdk
          ANDROIDNDK: /home/runner/.buildozer/android/platform/android-ndk-r25b
          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}
        run: |
          set -o pipefail
          export PATH="$JAVA_HOME/bin:$PATH"
          java -version
          buildozer -v android debug 2>&1 | tee buildozer.log

      - name: Upload build log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resume-app-build-log
          path: resume_app/buildozer.log
          if-no-files-found: ignore

      - name: Smoke test APK artifact structure
        if: success()
        run: |
          python - <<'PY'
          import glob
          import zipfile
          from pathlib import Path

          apks = glob.glob("resume_app/bin/*.apk")
          assert apks, "No APK found"
          apk = Path(apks[0])
          assert apk.stat().st_size > 1_000_000, f"APK unexpectedly small: {apk.stat().st_size}"

          with zipfile.ZipFile(apk, "r") as zf:
              names = set(zf.namelist())
              assert "AndroidManifest.xml" in names, "APK missing AndroidManifest.xml"
              assert any(name.endswith("classes.dex") for name in names), "APK missing classes.dex"
              assert any("lib/arm64-v8a/" in name for name in names), "APK missing arm64 native libs"

          print(f"APK smoke OK: {apk} ({apk.stat().st_size} bytes)")
          PY

      - name: Verify APK signing and manifest metadata
        if: success()
        run: |
          set -euo pipefail
          APK="$(ls resume_app/bin/*.apk | head -n 1)"
          SDK="$HOME/.buildozer/android/platform/android-sdk"
          AAPT="$(find "$SDK/build-tools" -type f -name aapt | sort -V | tail -n 1)"
          APKSIGNER="$(find "$SDK/build-tools" -type f -name apksigner | sort -V | tail -n 1)"

          test -n "$AAPT"
          test -n "$APKSIGNER"
          test -f "$APK"

          "$APKSIGNER" verify --print-certs "$APK" | tee apk_sign_verify.txt
          "$AAPT" dump badging "$APK" | tee apk_badging.txt
          "$AAPT" dump permissions "$APK" | tee apk_permissions.txt

          grep -q "package: name='org.textdocscript.resumepdf'" apk_badging.txt
          grep -q "sdkVersion:'24'" apk_badging.txt
          grep -q "targetSdkVersion:'33'" apk_badging.txt
          grep -q "uses-permission: name='android.permission.READ_EXTERNAL_STORAGE'" apk_permissions.txt
          grep -q "uses-permission: name='android.permission.WRITE_EXTERNAL_STORAGE'" apk_permissions.txt
          ! grep -q "android.permission.MANAGE_EXTERNAL_STORAGE" apk_permissions.txt
          ! grep -q "android.permission.INTERNET" apk_permissions.txt

      - name: Upload APK verification reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resume-app-apk-reports
          path: |
            apk_sign_verify.txt
            apk_badging.txt
            apk_permissions.txt
          if-no-files-found: ignore

      - name: Print error context (on failure)
        if: failure()
        working-directory: resume_app
        run: |
          echo "=== Gradle/build markers (last 80) ==="
          grep -nEi "gradlew failed|FAILURE: Build failed|What went wrong|Execution failed for task|Manifest merger failed|Android resource linking failed|A problem occurred|requires Java|unsupported class file|Traceback" buildozer.log | tail -n 80 || true
          echo "=== Tail 300 lines ==="
          tail -n 300 buildozer.log || true
          echo "=== Gradle invocation context (around 'gradlew clean assembleDebug') ==="
          line=$(grep -n "gradlew clean assembleDebug" buildozer.log | tail -n 1 | cut -d: -f1 || true)
          if [ -n "$line" ]; then
            start=$((line>120 ? line-120 : 1))
            end=$((line+220))
            sed -n "${start},${end}p" buildozer.log || true
          fi

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: resume-app-apk
          path: resume_app/bin/*.apk
          if-no-files-found: error
